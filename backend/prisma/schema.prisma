// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  AGENT
  ADMIN
}

enum LeadStatus {
  NEW
  CONTACTED
  SITE_VISIT_DONE
  NEGOTIATION
  CLOSED
  LOST
}

enum LeadSource {
  CALL
  WHATSAPP
  PORTAL
  WALK_IN
  FACEBOOK
  REFERRAL
  OTHER
}

enum WorkStatus {
  PENDING
  COMPLETED
}

enum FollowUpStatus {
  PENDING
  SELECT_DATE
  COMPLETED
  NOT_NEGOTIABLE
  INTERESTED
  FOLLOW_UP_LATER
  NOT_RESPONDING
  SITE_VISIT_DONE
}

enum CollegeStatus {
  NEW
  CONTACTED
  SEMINAR_SCHEDULED
  SEMINAR_DONE
  CONVERTED
  NOT_INTERESTED
}

enum CollegeFollowUpStatus {
  PENDING
  SELECT_DATE
  COMPLETED
  NOT_INTERESTED
  INTERESTED
  FOLLOW_UP_LATER
  NOT_RESPONDING
}

enum SeminarStatus {
  NOT_YET_SCHEDULED
  WAITING_FOR_APPROVAL
  SCHEDULED
  COMPLETED
  CANCELLED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(AGENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  leads        Lead[]
  works        Work[]
  colleges     College[]
  collegeWorks CollegeWork[]

  @@map("users")
}

model Lead {
  id                   String          @id @default(uuid())
  name                 String
  phone                String
  project              String?
  location             String?
  source               LeadSource
  status               LeadStatus      @default(NEW)
  followUpDate         DateTime // Mandatory - no lead without follow-up date
  followUpStatus       FollowUpStatus? // Follow-up status for tracking
  
  // New fields for money visibility
  expectedDealValue    Float?          @default(0) // Expected deal value in â‚¹
  commissionPercentage Float?          @default(2) // Commission percentage (default 2%)
  expectedCommission   Float?          @default(0) // Auto-calculated: expectedDealValue * commissionPercentage / 100
  lastContactedDate    DateTime?       // Last time this lead was contacted
  
  assignedToId         String
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relations
  assignedTo     User           @relation(fields: [assignedToId], references: [id], onDelete: Cascade)
  notes          Note[]
  works          Work[]
  activityLogs   ActivityLog[]

  @@map("leads")
}

model Note {
  id        String   @id @default(uuid())
  content   String
  leadId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("notes")
}

model Work {
  id           String     @id @default(uuid())
  leadId       String
  title        String
  description  String?
  dueDate      DateTime
  completedAt  DateTime?
  status       WorkStatus @default(PENDING)
  assignedToId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  lead       Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedTo User @relation(fields: [assignedToId], references: [id], onDelete: Cascade)

  @@map("works")
}

// Activity Log for tracking lead changes
model ActivityLog {
  id          String   @id @default(uuid())
  leadId      String
  agentId     String
  agentName   String   // Denormalized for quick display
  action      String   // e.g., "STATUS_CHANGE", "FOLLOWUP_UPDATE"
  oldValue    String?  // Previous value
  newValue    String?  // New value
  description String   // Human-readable description
  createdAt   DateTime @default(now())

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

// College Management System
model College {
  id                String                 @id @default(uuid())
  collegeName       String
  contactPerson     String
  phone             String
  email             String?
  address           String?
  city              String?
  seminarDate       DateTime?              // Scheduled seminar date
  seminarStatus     SeminarStatus          @default(NOT_YET_SCHEDULED)
  followUpDate      DateTime               // Next follow-up date (mandatory)
  status            CollegeStatus          @default(NEW)
  followUpStatus    CollegeFollowUpStatus? @default(PENDING)
  lastContactedDate DateTime?
  assignedToId      String
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  // Relations
  assignedTo   User                   @relation(fields: [assignedToId], references: [id], onDelete: Cascade)
  notes        CollegeNote[]
  works        CollegeWork[]
  activityLogs CollegeActivityLog[]

  @@map("colleges")
}

model CollegeNote {
  id        String   @id @default(uuid())
  content   String
  collegeId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  @@map("college_notes")
}

model CollegeWork {
  id           String     @id @default(uuid())
  collegeId    String
  title        String
  description  String?
  dueDate      DateTime
  completedAt  DateTime?
  status       WorkStatus @default(PENDING)
  assignedToId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  college    College @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  assignedTo User    @relation(fields: [assignedToId], references: [id], onDelete: Cascade)

  @@map("college_works")
}

model CollegeActivityLog {
  id          String   @id @default(uuid())
  collegeId   String
  agentId     String
  agentName   String
  action      String
  oldValue    String?
  newValue    String?
  description String
  createdAt   DateTime @default(now())

  // Relations
  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  @@map("college_activity_logs")
}
